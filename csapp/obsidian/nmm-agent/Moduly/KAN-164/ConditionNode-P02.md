# 분기 노드(Condition Node) 기술 명세서

워크플로우 엔진에서 **분기 노드(Condition Node)** 는 이전 노드들의 실행 결과를 기반으로 조건을 평가하고, 그 결과에 따라 워크플로우의 실행 흐름을 서로 다른 경로로 분기시키는 역할을 담당한다. 이 노드는 단순한 데이터 처리 노드가 아니라, 전체 워크플로우의 제어 흐름을 결정하는 핵심 제어 노드이다.

분기 노드는 입력 데이터로부터 비교 대상 값을 추출하기 위해 `variable_selector`를 사용하며, 추출된 값은 지정된 `operator`와 `value`를 기준으로 평가된다. 조건 평가 결과가 참(True)이면 `"true"` 핸들로, 거짓(False)이면 `"false"` 핸들로 연결된 다음 노드가 실행된다.

---

## 분기 노드의 데이터 구조

분기 처리를 위해 기존 엣지(Edge) 구조가 확장된다. 각 엣지는 단순히 source와 target을 연결하는 역할뿐 아니라, 분기 노드의 어느 결과에 해당하는 경로인지 명시할 수 있어야 한다. 이를 위해 `sourceHandle`과 `targetHandle` 필드가 추가되며, 특히 `sourceHandle`은 `"true"` 또는 `"false"` 값을 갖는다. 이를 통해 분기 노드의 실행 결과와 엣지의 분기 조건을 매칭할 수 있다.

분기 노드 자체의 핵심 데이터 구조는 **Condition 엔티티**와 **ConditionNodeData**로 구성된다. 하나의 Condition은 단일 비교 조건을 의미하며, 고유한 `id`, 값 추출 경로를 나타내는 `variable_selector`, 비교 방식인 `operator`, 그리고 비교 대상 값인 `value`를 포함한다. `variable_selector`는 `[node_id, output_key, ...]` 형태의 배열로, 이전 노드의 실행 결과에서 중첩된 값을 안전하게 추출하기 위한 경로를 정의한다.

여러 개의 조건이 동시에 존재할 수 있으며, 이 조건들은 `logical_operator`에 따라 결합된다. 기본값은 `"and"`로, 모든 조건이 참일 때만 최종 결과가 참이 된다. `"or"`가 지정된 경우에는 하나라도 참이면 전체 조건 평가 결과는 참이 된다.

---

## ConditionNode의 동작 방식

ConditionNode는 워크플로우 엔진의 일반 노드 인터페이스를 따르며, 내부적으로 조건 평가 로직을 수행한다. 노드가 실행되면, 먼저 자신이 보유한 모든 조건을 순회하면서 각 조건을 개별적으로 평가한다. 각 조건 평가는 `variable_selector`를 통해 입력 데이터에서 실제 값을 추출하는 단계와, 해당 값을 연산자에 따라 비교하는 단계로 나뉜다.

값 추출 과정에서는 입력 데이터가 중첩된 딕셔너리 구조일 수 있음을 고려하여, 키 경로를 순차적으로 따라가며 값을 찾는다. 중간 단계에서 값이 존재하지 않거나 구조가 일치하지 않는 경우에는 `None`으로 처리된다.

연산자 적용 단계에서는 조건에 정의된 비교 연산자에 따라 실제 값과 기대 값을 비교한다. 문자열 비교 연산자(equals, contains, starts_with 등), 비어 있음 여부 판단(is_empty, is_not_empty), 그리고 수치 비교 연산자(greater_than, less_than 등)를 모두 지원하며, 수치 비교의 경우 내부적으로 float 변환을 수행한다.

모든 조건 평가가 끝나면, 각 조건의 결과를 `logical_operator` 기준으로 결합하여 최종 결과를 도출한다. 이 최종 결과는 Boolean 값으로 표현되며, 동시에 `"true"` 또는 `"false"` 중 하나의 `selected_handle` 값으로 변환된다.

ConditionNode의 실행 결과는 단순히 조건의 참·거짓만 반환하는 것이 아니라, 이후 워크플로우 엔진이 어떤 엣지를 따라가야 하는지를 명확히 지시하는 역할을 한다.

---

## NodeFactory 등록

ConditionNode가 워크플로우에서 정상적으로 사용되기 위해서는 NodeFactory에 등록되어야 한다. 이를 통해 워크플로우 정의(JSON 또는 DB 저장 구조 등)에서 `"conditionNode"` 타입을 가진 노드를 로딩할 때, 해당 노드가 ConditionNode와 ConditionNodeData 조합으로 생성된다. 이 등록 과정은 기존 startNode나 answerNode와 동일한 방식으로 이루어진다.

---

## WorkflowEngine의 분기 처리 로직

기존 워크플로우 엔진은 단순히 그래프 구조를 따라 다음 노드들을 탐색했다. 그러나 분기 노드가 도입되면서, 다음 노드를 선택하는 로직은 노드 실행 결과에 의존하도록 변경된다.

엔진은 노드 실행이 끝난 후, `_get_next_nodes()` 메서드를 호출하여 실제로 실행 가능한 다음 노드 목록을 계산한다. 이 메서드는 현재 노드에서 출발하는 모든 엣지를 순회하며, 노드 실행 결과에 `selected_handle`이 존재하는 경우 해당 값과 엣지의 `sourceHandle`을 비교한다. 두 값이 일치하는 엣지만 다음 실행 후보로 선택된다.

이 과정 덕분에 분기 노드에서 선택되지 않은 경로는 그래프 상에 존재하더라도 실행 큐에 들어가지 않으며, 결과적으로 워크플로우는 조건 평가 결과에 따라 단 하나의 경로만 따라 진행된다.

---

## 입출력 정의

ConditionNode의 입력은 이전 노드들의 실행 결과를 담고 있는 딕셔너리 형태의 `inputs`이다. 각 조건은 이 입력 데이터에서 `variable_selector`가 가리키는 값을 추출하여 평가에 사용한다.

출력은 두 개의 핵심 값을 포함한다. 첫 번째는 전체 조건 평가 결과를 나타내는 `result`이며, 두 번째는 워크플로우 분기를 위해 사용되는 `selected_handle`이다. `selected_handle`은 `result` 값에 따라 `"true"` 또는 `"false"` 중 하나로 결정된다.

---

## 전체 실행 흐름 요약

워크플로우 실행 중 ConditionNode에 도달하면, 엔진은 해당 노드를 실행하고 조건 평가를 수행한다. 조건 평가 결과에 따라 하나의 분기 핸들이 선택되며, 워크플로우 엔진은 이 핸들과 일치하는 엣지만을 따라 다음 노드를 실행한다. 선택되지 않은 분기의 노드들은 실행되지 않으며, 이는 워크플로우 제어 흐름을 명확하고 예측 가능하게 만든다.

이러한 구조를 통해 분기 노드는 단순한 비교 기능을 넘어, 워크플로우 전반의 흐름을 제어하는 핵심 구성 요소로 작동한다.
